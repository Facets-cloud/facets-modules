intent: service
flavor: k8s-pa
version: '0.2'
description: Unified AWS cloud service module supporting deployment, cronjob, job,
  and statefulset workloads
clouds:
- aws
artifact_inputs:
  primary:
    attribute_path: spec.release.image
    artifact_type: docker_image
inputs:
  kubernetes_details:
    optional: false
    type: '@outputs/kubernetes'
    default:
      resource_type: kubernetes_cluster
      resource_name: default
    providers:
    - kubernetes
    - kubernetes-alpha
    - helm
  kubernetes_node_pool_details:
    type: '@outputs/aws_karpenter_nodepool'
    optional: true
  artifactories:
    optional: true
    type: '@outputs/artifactories'
    default:
      resource_type: artifactories
      resource_name: default
  vpa_details:
    optional: true
    type: '@outputs/vpa'
    default:
      resource_type: configuration
      resource_name: vpa
outputs:
  default:
    type: '@outputs/service'
metadata:
  title: Metadata of service
  type: object
  properties:
    namespace:
      type: string
      title: Namespace
      description: Namespace in which service should be deployed
spec:
  title: AWS Cloud Service
  type: object
  properties:
    type:
      type: string
      title: Service Type
      description: Type of Kubernetes workload to deploy
      enum:
      - application
      - cronjob
      - job
      - statefulset
      default: application
    restart_policy:
      type: string
      title: Restart Policy
      description: Restart Policy - Always, OnFailure, Never
      x-ui-override-disable: true
      x-ui-visible-if:
        field: spec.type
        values:
        - application
        - statefulset
      enum:
      - Always
      - OnFailure
      - Never
    enable_host_anti_affinity:
      type: boolean
      title: Enable Host Anti-Affinity
      description: Distribute instances across different physical hosts within cluster
      x-ui-visible-if:
        field: spec.type
        values:
        - application
        - statefulset
    cronjob:
      type: object
      title: Cronjob
      description: Cron scheduler to be specified in cron format
      x-ui-override-disable: true
      x-ui-toggle: true
      x-ui-visible-if:
        field: spec.type
        values:
        - cronjob
      properties:
        schedule:
          title: Schedule
          type: string
          description: Cron scheduler to be specified in cron format
          x-ui-placeholder: Enter the cron schedule (e.g., * * * * *)
        suspend:
          title: Suspend
          type: boolean
          description: Suspend all executions
        concurrency_policy:
          title: Concurrent Policy
          type: string
          description: Specifies how to treat concurrent executions of a job created
            by this cron job
          enum:
          - Allow
          - Forbid
          - Replace
      required:
      - schedule
      - suspend
      - concurrency_policy
    job:
      type: object
      title: Job
      description: Manage execution of a one-off task or batch process, ensuring it
        completes successfully
      x-ui-override-disable: true
      x-ui-toggle: true
      x-ui-visible-if:
        field: spec.type
        values:
        - job
        - cronjob
      properties:
        retry:
          type: string
          default: 5
          minimum: 1
          x-ui-placeholder: Enter the minimum retry count for your job (default is
            5)
          description: Number of time you want to retry the job before calling it
            a failure
          pattern: ^(100|[1-9][0-9]?)$
          x-ui-error-message: The retry count must be a positive integer between 1
            and 100.
      required:
      - retry
    persistent_volume_claims:
      type: object
      title: Persistent Volume Claim
      Description: PVCs that you will create and mount to your statefulset
      x-ui-override-disable: true
      x-ui-toggle: true
      x-ui-visible-if:
        field: spec.type
        values:
        - statefulset
      patternProperties:
        ^[a-zA-Z0-9_-]*$:
          type: object
          title: PVC
          description: Define volume details
          properties:
            access_mode:
              title: Access Mode
              type: string
              enum:
              - ReadWriteOnce
              - ReadWriteMany
              description: Define read-write access of the pvc
            storage_size:
              type: string
              title: Storage Size
              description: The storage size of the pvc , it should be specified like
                `10Gi`
              minLength: 1
              pattern: ^(0\.[1-9]|[1-9](\.[0-9]+)?|[1-5][0-9](\.[0-9]+)?|6[0-4])Gi$|^([1-9](\.[0-9]+)?|[1-9][0-9]{1,3}(\.[0-9]+)?|[1-5][0-9]{4}(\.[0-9]+)?|6[0-3][0-9]{3}(\.[0-9]+)?|64000)Mi$
              x-ui-placeholder: e.g., '800Mi' or '1.5Gi'
              x-ui-error-message: Value doesn't match pattern, it should be number
                ranging from 1Gi to 64Gi or 1Mi to 64000Mi
            path:
              type: string
              title: Path
              description: Path to mount the PVC
              pattern: ^(/[^/]+)*(/)?$
              x-ui-error-message: 'Value doesn''t match pattern, eg: / or /<path>
                etc'
              x-ui-placeholder: Enter the storage size, eg. /data/temp
          required:
          - access_mode
          - path
          - storage_size
    cloud_permissions:
      type: object
      title: Cloud Permissions
      description: Assign AWS roles, define access levels, and enforce conditions
        for managing resource security and compliance
      x-ui-toggle: true
      properties:
        aws:
          type: object
          title: AWS
          x-ui-toggle: true
          properties:
            enable_irsa:
              type: boolean
              title: Enable IRSA
              description: Enable this to grant fine-grained AWS permissions to Kubernetes
                workloads using service accounts.
            iam_policies:
              type: object
              title: IAM policies
              description: Define IAM policies to manage permissions, control-access
                and secure resources
              patternProperties:
                ^[a-zA-Z0-9_.-]*$:
                  title: policy_name
                  properties:
                    arn:
                      title: ARN
                      type: string
                      pattern: ^(arn:aws:iam::(\d{12}|aws):policy\/[A-Za-z0-9+=,.@\-_]+|\$\{[A-Za-z0-9._-]+\})$
                      x-ui-placeholder: 'IAM policy example. Eg: arn:aws:iam::123456789012:policy/policy1'
                      x-ui-error-message: 'Value doesn''t match pattern, accepted
                        value pattern Eg: arn:aws:iam::123456789012:policy/policy1'
                      x-ui-output-type: iam_policy_arn
                      x-ui-typeable: true
                  required:
                  - arn
                  type: object
    runtime:
      type: object
      title: Runtime
      description: Customize service runtime settings like ports, healthchecks etc.
      properties:
        command:
          type: array
          title: Command
          description: Command to run in the container
          items:
            type: string
          x-ui-command: true
          x-ui-override-disable: true
        args:
          type: array
          title: Arguments
          description: Arguments to pass to the command
          items:
            type: string
          x-ui-command: true
          x-ui-override-disable: true
        size:
          type: object
          title: Size
          description: Configure container size to meet resource requirements
          properties:
            cpu:
              type: string
              title: CPU
              description: CPU size
              x-ui-compare:
                field: spec.runtime.size.cpu_limit
                comparator: <=
                x-ui-error-message: CPU cannot be more than CPU limit
              pattern: ^([1-9]|[12][0-9]|3[0-2])$|^(3[0-1][0-9]{3}|[1-2][0-9]{4}|[1-9][0-9]{0,3}|32000)m$
              x-ui-placeholder: Enter CPU requests for your application
              x-ui-error-message: Value doesn't match pattern, it should be number
                ranging from 1 to 32 or 1m to 32000m
            memory:
              type: string
              title: Memory
              description: Memory size
              x-ui-compare:
                field: spec.runtime.size.memory_limit
                comparator: <=
                x-ui-error-message: Memory cannot be more than memory limit
              pattern: ^([1-9]|[1-5][0-9]|6[0-4])Gi$|^([1-9]|[1-9][0-9]{1,3}|[1-5][0-9]{4}|6[0-3][0-9]{3}|64000)Mi$
              x-ui-placeholder: Enter Memory requests for your application
              x-ui-error-message: Value doesn't match pattern, it should be number
                ranging from 1Gi to 64Gi or 1Mi to 64000Mi
            cpu_limit:
              type: string
              title: CPU Limit
              description: CPU limit size
              x-ui-compare:
                field: spec.runtime.size.cpu
                comparator: '>='
                x-ui-error-message: CPU limit cannot be less than CPU
              pattern: ^([1-9]|[12][0-9]|3[0-2])$|^(3[0-1][0-9]{3}|[1-2][0-9]{4}|[1-9][0-9]{0,3}|32000)m$
              x-ui-placeholder: Enter CPU limits for your application
              x-ui-error-message: Value doesn't match pattern, it should be number
                ranging from 1 to 32 or 1m to 32000m
            memory_limit:
              type: string
              title: Memory Limit
              description: Memory limit size
              x-ui-compare:
                field: spec.runtime.size.memory
                comparator: '>='
                x-ui-error-message: Memory limit cannot be less than memory
              pattern: ^([1-9]|[1-5][0-9]|6[0-4])Gi$|^([1-9]|[1-9][0-9]{1,3}|[1-5][0-9]{4}|6[0-3][0-9]{3}|64000)Mi$
              x-ui-placeholder: Enter Memory limits for your application
              x-ui-error-message: Value doesn't match pattern, it should be number
                ranging from 1Gi to 64Gi or 1Mi to 64000Mi
          required:
          - cpu
          - memory
        ports:
          type: object
          title: Ports
          x-ui-override-disable: true
          description: Port mappings
          x-ui-visible-if:
            field: spec.type
            values:
            - application
            - statefulset
          patternProperties:
            ^[0-9]+[m]?$:
              type: object
              title: Port Name
              description: Define port allocation to facilitate communication with
                service
              properties:
                port:
                  type: string
                  title: Port
                  description: Port on which application is running
                  pattern: ^(?!0$)([1-9][0-9]{0,3}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$
                  x-ui-unique: true
                  x-ui-placeholder: Enter the port number to expose for your application
                    container
                  x-ui-error-message: Value doesn't match pattern, it should be number
                    ranging from 1-65535
                service_port:
                  type: string
                  title: Service Port
                  description: Port from which application service can be exposed
                  pattern: ^(?!0$)([1-9][0-9]{0,3}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$
                  x-ui-unique: true
                  x-ui-placeholder: Enter the port number to expose for your application
                    service
                  x-ui-error-message: Value doesn't match pattern, it should be number
                    ranging from 1-65535
                protocol:
                  type: string
                  title: Protocol
                  description: TCP or UDP
                  enum:
                  - tcp
                  - udp
              required:
              - protocol
              - port
        health_checks:
          type: object
          title: Health Checks
          description: Ensure service remains responsive and operational. Assess its
            status and performance.
          x-ui-override-disable: true
          x-ui-toggle: true
          x-ui-visible-if:
            field: spec.type
            values:
            - application
            - statefulset
          properties:
            readiness_check_type:
              type: string
              title: Readiness Check Type
              default: None
              x-ui-no-sort: true
              enum:
              - None
              - PortCheck
              - HttpCheck
              - ExecCheck
            liveness_check_type:
              type: string
              title: Liveness Check Type
              default: None
              x-ui-no-sort: true
              enum:
              - None
              - PortCheck
              - HttpCheck
              - ExecCheck
          required:
          - readiness_check_type
          - liveness_check_type
        autoscaling:
          type: object
          title: Autoscaling
          description: Automatically adjust resources based on demand for optimal
            performance
          x-ui-toggle: true
          x-ui-visible-if:
            field: spec.type
            values:
            - application
            - statefulset
          properties:
            min:
              type: integer
              title: Min
              default: 1
              minimum: 1
              maximum: 200
              description: Min replicas
            max:
              type: integer
              title: Max
              default: 1
              minimum: 1
              maximum: 200
              description: Max replicas
            scaling_on:
              type: string
              title: Scale based on
              default: CPU
              enum:
              - CPU
              - RAM
            cpu_threshold:
              type: string
              title: CPU Threshold
              description: Max CPU threshold
              pattern: ^(100|[1-9][0-9]?)$
              x-ui-visible-if:
                field: spec.runtime.autoscaling.scaling_on
                values:
                - CPU
            ram_threshold:
              type: string
              title: RAM Threshold
              description: Max RAM threshold
              pattern: ^(1?[0-9]?[0-9]|100)$
              x-ui-visible-if:
                field: spec.runtime.autoscaling.scaling_on
                values:
                - RAM
      required:
      - size
    env:
      title: Environment Variables
      description: Map of environment variables passed to the main container.
      type: object
      x-ui-yaml-editor: true
  required:
  - type
  - runtime
  x-ui-order:
  - type
  - restart_policy
  - enable_host_anti_affinity
  - cronjob
  - job
  - persistent_volume_claims
  - cloud_permissions
  - runtime
  - env
sample:
  $schema: https://facets-cloud.github.io/facets-schemas/schemas/service/service.schema.json
  flavor: k8s-pa
  metadata:
    labels:
      deliveryType: MANUAL
  kind: service
  disabled: true
  version: '0.2'
  spec:
    type: application
    enable_host_anti_affinity: false
    restart_policy: Always
    cloud_permissions:
      aws:
        enable_irsa: false
    runtime:
      args: []
      command: []
      autoscaling:
        scaling_on: CPU
        min: 1
        max: 1
        cpu_threshold: '50'
      ports: {}
      size:
        cpu: 300m
        memory: 1Gi
        cpu_limit: 1000m
        memory_limit: 5Gi
      health_checks:
        readiness_check_type: None
        liveness_check_type: None
    env:
      LOG_LEVEL: INFO
