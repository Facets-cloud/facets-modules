# Kubernetes Cluster - AWS EKS Flavor (Version 0.1)

## Overview

This document describes the specification for provisioning a Kubernetes cluster on Amazon Web Services (AWS) using the Elastic Kubernetes Service (EKS) flavor. It allows for detailed configuration of the cluster itself, various types of nodepools, tagging, and management of EKS addons.

The primary purpose is to define a structured and versioned way to create and manage EKS clusters, enabling consistent deployments and clear configuration management.

## Configurability

This specification offers a wide range of configurable parameters to tailor the EKS cluster to specific needs. These are organized into several main sections:

### 1. Cluster (`spec.cluster`)

This section defines the core EKS cluster configurations:

* **`cloudwatch_log_retention_days`**:
    * **Description**: Specifies the retention period (in days) for CloudWatch Logs generated by the EKS cluster.
    * **Type**: Number
    * **Default**: 365
    * **Constraints**: Minimum 1, Maximum 3650.
    * **UI Placeholder**: `e.g. 30`
    * **Note**: This setting is for overrides only.

* **`public_cidr_whitelist`**:
    * **Description**: A comma-separated list of CIDR blocks allowed to access the Amazon EKS public API server endpoint.
    * **Type**: String
    * **Default**: `0.0.0.0/0` (allows access from any IP)
    * **Pattern**: Validates a comma-separated list of CIDR blocks (e.g., `10.45.0.0/16,10.60.0.0/16`).
    * **Error Message**: "Regex for CIDR block did not match. Make sure valid space separated CIDR blocks are given" (Note: the pattern suggests comma separation, while the message mentions space separation. The pattern is likely the correct one to follow).
    * **Note**: This setting is for overrides only.

* **`kms_keys`**:
    * **Description**: Configuration for AWS Key Management Service (KMS) keys used for encrypting Kubernetes secrets.
    * **`deletion_window_in_days`**:
        * **Description**: The waiting period (in days) before KMS keys are deleted after scheduling deletion.
        * **Type**: Number
        * **Default**: 7
        * **Constraints**: Minimum 7, Maximum 30.
        * **Error Message**: "Deletion window must be between 7 and 30".
        * **Note**: This setting is for overrides only.
    * **`enable_rotation`**:
        * **Description**: A boolean flag to enable or disable automatic key rotation for the KMS key.
        * **Type**: Boolean
    * **`rotation_period_in_days`**:
        * **Description**: Specifies the rotation period in days for the KMS key if rotation is enabled.
        * **Type**: Number
        * **Default**: 90
        * **Constraints**: Minimum 1, Maximum 365.
        * **Visibility**: Only visible/applicable if `enable_rotation` is `true`.
        * **Note**: This setting is for overrides only.

* **`default_reclaim_policy`**:
    * **Description**: Defines how resources are handled after a persistent volume is released for the default storage class. **Important**: Changes to this policy will not affect already created storage classes.
    * **Type**: String
    * **Default**: `Delete`
    * **Enum**: `Delete`, `Retain`

### 2. Nodepools (`spec.nodepools`)

This section details the configuration for different nodepools within the cluster.

#### a. Default Nodepool (`spec.nodepools.default`)

* **Description**: Specifications for the default nodepool.
* **`instance_types`** (Required):
    * **Description**: A space-separated list of EC2 instance types for the worker nodes in this pool.
    * **Type**: Array (of strings)
    * **UI Placeholder**: `e.g. m4.xlarge t3.2xlarge`
    * **Note**: This setting is for overrides only.
* **`root_disk_volume`**:
    * **Description**: The size of the root disk (in GiB) for worker nodes.
    * **Type**: Number
    * **Default**: 100
    * **Constraints**: Minimum 30, Maximum 500.
    * **UI Placeholder**: `e.g. 100`
    * **Note**: This setting is for overrides only.
* **`node_lifecycle_type`**:
    * **Description**: The lifecycle plan for worker nodes (e.g., Spot or On-Demand instances).
    * **Type**: String
    * **Default**: `SPOT`
    * **Enum**: `ON_DEMAND`, `SPOT`
    * **Note**: This setting is for overrides only.
* **`max_nodes`**:
    * **Description**: The maximum number of worker nodes allowed in this nodepool.
    * **Type**: Number
    * **Default**: 200
    * **Constraints**: Minimum 1, Maximum 200.
    * **Note**: This setting is for overrides only.
* **`ami_id`**:
    * **Description**: The ID of a self-owned Amazon Machine Image (AMI) to be used for the Kubernetes nodes.
    * **Type**: String
    * **Note**: This setting is for overrides only.
* **`ami_name_filter`**:
    * **Description**: A name filter to select an AMI for the Kubernetes nodes.
    * **Type**: String
    * **Note**: This setting is for overrides only.
* **`ami_owner_id`**:
    * **Description**: The AWS account ID of the AMI owner, used in conjunction with `ami_name_filter`.
    * **Type**: String
    * **Note**: This setting is for overrides only.
* **UI Order**: `instance_types`, `node_lifecycle_type`, `root_disk_volume`, `max_nodes`, `ami_id`, `ami_name_filter`, `ami_owner_id`

#### b. Facets Dedicated Nodepool (`spec.nodepools.facets_dedicated`)

* **Description**: Specifications for a dedicated nodepool, often used for specific workloads ("facets").
* **`enable`**:
    * **Description**: A boolean flag to enable or disable this dedicated nodepool.
    * **Type**: Boolean
    * **Default**: `true`
    * **Note**: This setting is for overrides only.
* The following parameters are only visible/applicable if `enable` is `true`:
    * **`root_disk_volume`**:
        * **Description**: Disk size (GiB) for worker nodes.
        * **Type**: Number
        * **Default**: 100
        * **Constraints**: Minimum 30, Maximum 500.
        * **UI Placeholder**: `e.g. 100`
        * **Note**: This setting is for overrides only.
    * **`node_lifecycle_type`**:
        * **Description**: Lifecycle plan for worker nodes.
        * **Type**: String
        * **Default**: `SPOT`
        * **Enum**: `ON_DEMAND`, `SPOT`
        * **Note**: This setting is for overrides only.
    * **`max_nodes`**:
        * **Description**: Maximum number of worker nodes.
        * **Type**: Number
        * **Default**: 8
        * **Constraints**: Minimum 1, Maximum 200.
        * **Note**: This setting is for overrides only.
    * **`instance_type`** (Required if enabled):
        * **Description**: The EC2 instance type for this nodepool.
        * **Type**: String
        * **Default**: `m4.xlarge`
        * **UI Placeholder**: `e.g. 'm4.xlarge,t3.2xlarge'` (Note: Placeholder suggests multiple, but type is string, implying one primary type here).
        * **Note**: This setting is for overrides only.
    * **`ami_id`**:
        * **Description**: Self-owned AMI ID.
        * **Type**: String
        * **Note**: This setting is for overrides only.
    * **`ami_name_filter`**:
        * **Description**: AMI name filter.
        * **Type**: String
        * **Note**: This setting is for overrides only.
    * **`ami_owner_id`**:
        * **Description**: AMI owner ID for use with name filter.
        * **Type**: String
        * **Note**: This setting is for overrides only.
* **UI Order**: `enable`, `instance_type`, `node_lifecycle_type`, `root_disk_volume`, `max_nodes`, `ami_id`, `ami_name_filter`, `ami_owner_id`

#### c. Ondemand Fallback Nodepool (`spec.nodepools.ondemand_fallback`)

* **Description**: Specifications for an On-Demand fallback nodepool, potentially used if Spot instances are unavailable or not desired for certain fallback scenarios.
* **`enable`**:
    * **Description**: A boolean flag to enable or disable this nodepool.
    * **Type**: Boolean
    * **Default**: `true`
    * **Note**: This setting is for overrides only.
* The following parameters are only visible/applicable if `enable` is `true`:
    * **`instance_type`** (Required if enabled):
        * **Description**: The EC2 instance type for this nodepool.
        * **Type**: String
        * **Default**: `m5.2xlarge`
        * **Note**: This setting is for overrides only.
    * **`max_nodes`**:
        * **Description**: Maximum number of nodes in this nodepool.
        * **Type**: Number
        * **Default**: 100
        * **Constraints**: Minimum 0, Maximum 100.
        * **Note**: This setting is for overrides only.
    * **`ami_id`**:
        * **Description**: Self-owned AMI ID.
        * **Type**: String
        * **Note**: This setting is for overrides only.
    * **`ami_name_filter`**:
        * **Description**: AMI name filter.
        * **Type**: String
        * **Note**: This setting is for overrides only.
    * **`ami_owner_id`**:
        * **Description**: AMI owner ID for use with name filter.
        * **Type**: String
        * **Note**: This setting is for overrides only.
* **UI Order**: `enable`, `instance_type`, `max_nodes`, `ami_id`, `ami_name_filter`, `ami_owner_id`

### 3. Tags (`spec.tags`)

* **Description**: Key-value pairs (in YAML format) to be added as tags to the EKS cluster.
* **Type**: Object
* **UI Placeholder**: `"Enter the value of the secret. Eg. key1: value1"` (Note: Placeholder seems to refer to secrets, but it's for tags.)
* **Formatting**: YAML format, e.g., `key: value` (space after `:`).
* **UI Feature**: YAML editor enabled.
* **Note**: This setting is for overrides only.

### 4. Addons (`spec.addons`)

* **Description**: Specifications for EKS addons to be installed and configured on the cluster.
* **Type**: Object, where each key is an addon name (matching `^[a-zA-Z-]+$`).
* For each addon, the following properties can be configured:
    * **`enable`**:
        * **Description**: Set to `true` to enable the addon.
        * **Type**: Boolean
    * **`configuration_values`**:
        * **Description**: Configuration values for the addon (likely a JSON or YAML string).
        * **Type**: String
        * **Note**: This setting is for overrides only.
    * **`resolve_conflicts`**:
        * **Description**: Set to `true` to resolve conflicts during addon installation/update.
        * **Type**: Boolean
        * **Note**: This setting is for overrides only.
    * **`addon_version`**:
        * **Description**: The specific version of the addon to install.
        * **Type**: String
        * **Note**: This setting is for overrides only.
    * **`tags`**:
        * **Description**: Key-value pairs (YAML format) for tagging the addon.
        * **Type**: Object
        * **UI Feature**: YAML editor enabled.
        * **Note**: This setting is for overrides only.
    * **`preserve`**:
        * **Description**: Set to `true` to preserve the addon during cluster deletion or updates.
        * **Type**: Boolean
        * **Note**: This setting is for overrides only.
    * **`service_account_role_arn`**:
        * **Description**: The ARN of the IAM role to be used by the addon's service account.
        * **Type**: String
        * **Note**: This setting is for overrides only.

## Usage

This specification is intended to be used as an input for an automated system or tool that provisions and manages AWS EKS clusters. The `sample` section provides a basic template:
