intent: kubernetes_cluster
flavor: aws_eks_demo
alias-flavors:
- default
version: '0.3'
clouds:
- aws
title: EKS Cluster with Auto Mode support
description: A Kubernetes EKS cluster module with auto mode enabled by default and
  all necessary configurations preset.
allow_skipping_module_on_selective_release: false
spec:
  type: object
  x-ui-order:
  - cluster
  - node_pools
  - secret_copier
  - tags
  properties:
    secret_copier:
      type: object
      title: Secret Copier
      description: Configuration for the Secret Copier.
      x-ui-toggle: false
      properties:
        enabled:
          type: boolean
          title: Enabled
          description: Enable secret copier.
          default: true
        values:
          type: object
          title: Values
          description: Values to pass to the secret copier.
          default: {}
          x-ui-yaml-editor: true
    cluster:
      type: object
      title: Cluster
      description: Configuration for the EKS cluster.
      x-ui-toggle: false
      properties:
        kubernetes_version:
          type: string
          title: Kubernetes Version
          description: Version of Kubernetes to use for the EKS cluster.
          default: '1.31'
        cluster_endpoint_public_access:
          type: boolean
          title: Cluster Endpoint Public Access
          description: Whether the Amazon EKS public API server endpoint is enabled.
          default: true
          x-ui-overrides-only: true
        cluster_endpoint_private_access:
          type: boolean
          title: Cluster Endpoint Private Access
          description: Whether the Amazon EKS private API server endpoint is enabled.
          default: true
          x-ui-overrides-only: true
        cluster_endpoint_public_access_cidrs:
          type: array
          title: Cluster Endpoint Public Access CIDRs
          description: List of CIDR blocks which can access the Amazon EKS public
            API server endpoint.
          default:
          - 0.0.0.0/0
          x-ui-overrides-only: true
        cluster_endpoint_private_access_cidrs:
          type: array
          title: Cluster Endpoint Private Access CIDRs
          description: List of CIDR blocks which can access the Amazon EKS private
            API server endpoint.
          default:
          - 0.0.0.0/0
          x-ui-overrides-only: true
        cloudwatch_log_group_retention_in_days:
          type: number
          title: Cloudwatch Log Group Retention In Days
          description: Retention period for the Cloudwatch log group.
          default: 90
        cluster_enabled_log_types:
          type: array
          title: Cluster Enabled Log Types
          description: List of log types to enable for the EKS cluster.
          default:
          - api
          - audit
          - authenticator
          x-ui-overrides-only: true
        enable_cluster_encryption:
          type: boolean
          title: Enable Cluster Encryption
          description: Enable encryption for the cluster secrets.
          default: true
        default_reclaim_policy:
          type: string
          title: Default Reclaim Policy
          description: Default reclaim policy for the EKS cluster.
          default: Delete
          x-ui-overrides-only: true
          enum:
          - Delete
          - Retain
        kms:
          type: object
          title: KMS
          description: Configuration for the KMS key.
          x-ui-toggle: false
          x-ui-overrides-only: true
          properties:
            deletion_window_in_days:
              title: Deletion Window
              description: Waiting period in days after which kms keys are deleted
              type: number
              minimum: 7
              maximum: 30
              default: 7
              x-ui-error-message: Deletion window must be between 7 and 30
            enable_rotation:
              title: Enable Rotation for KMS
              description: Specifies whether key rotation is enabled
              type: boolean
              default: false
            rotation_period_in_days:
              title: Rotation Period for KMS in days
              description: Specifies Rotation Period for KMS in days
              type: number
              default: 90
              minimum: 1
              maximum: 365
              x-ui-visible-if:
                field: spec.cluster.kms_keys.enable_rotation
                values:
                - true
      required:
      - kubernetes_version
    tags:
      type: object
      title: Tags
      description: Tags to apply to the EKS cluster.
      x-ui-toggle: false
      x-ui-yaml-editor: true
    node_pools:
      type: object
      title: Node Pools
      description: Configuration for managed node pools, that are created by facets
      x-ui-toggle: false
      properties:
        dedicated:
          type: object
          title: Dedicated Node Pool
          description: Configuration for dedicated managed node pool.
          x-ui-toggle: false
          properties:
            enabled:
              type: boolean
              title: Enabled
              description: Enable dedicated managed node pool.
              default: false
            max_cpu:
              type: string
              title: Maximum CPU
              description: Maximum total CPU cores for this node pool.
              default: '1000'
              pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
              x-ui-error-message: Maximum CPU must be a valid Kubernetes resource
                quantity (e.g., 1000, 1000m, 1k)
              x-ui-visible-if:
                field: spec.node_pools.dedicated.enabled
                values:
                - true
            max_memory:
              type: string
              title: Maximum Memory
              description: Maximum total memory for this node pool.
              default: 1000Gi
              pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
              x-ui-error-message: Maximum memory must be a valid Kubernetes resource
                quantity (e.g., 1000Gi, 1Ti, 1000000Mi)
              x-ui-visible-if:
                field: spec.node_pools.dedicated.enabled
                values:
                - true
            use_instance_family:
              type: boolean
              title: Use Instance Family
              description: Toggle to select by instance family (category) or by specific
                instance type.
              default: false
              x-ui-visible-if:
                field: spec.node_pools.dedicated.enabled
                values:
                - true
            instance_family:
              type: string
              title: Instance Family (Category)
              description: Comma-separated EC2 instance families/categories (e.g.,
                c,m,r,g)
              default: c
              pattern: ^[a-z][0-9]*[a-z]*(,[a-z][0-9]*[a-z]*)*$
              x-ui-error-message: Instance families must be comma-separated valid
                EC2 families (e.g., c,m,r,g)
              x-ui-visible-if:
                field: spec.node_pools.dedicated.use_instance_family
                values:
                - true
            instance_types:
              type: string
              title: Instance Types
              description: Comma-separated EC2 instance types for the worker nodes
                (e.g., t3.medium,t3.large)
              default: t3.medium
              pattern: ^[a-z][0-9]+[a-z]*\.(nano|micro|small|medium|large|xlarge|[0-9]+xlarge)(,[a-z][0-9]+[a-z]*\.(nano|micro|small|medium|large|xlarge|[0-9]+xlarge))*$
              x-ui-error-message: Instance types must be comma-separated valid EC2
                instance types (e.g., t3.medium,t3.large)
              x-ui-visible-if:
                field: spec.node_pools.dedicated.use_instance_family
                values:
                - false
            capacity_types:
              type: string
              title: Capacity Types
              description: Comma-separated capacity types (e.g., spot,on-demand)
              default: spot
              pattern: ^(on-demand|spot)(,(on-demand|spot))*$
              x-ui-error-message: Capacity types must be comma-separated values from
                on-demand,spot
              x-ui-visible-if:
                field: spec.node_pools.dedicated.enabled
                values:
                - true
          required:
          - enabled
          - max_cpu
          - max_memory
          - capacity_types
        default:
          type: object
          title: Default Node Pool
          description: Configuration for default managed node pool.
          x-ui-toggle: false
          properties:
            enabled:
              type: boolean
              title: Enabled
              description: Enable default managed node pool.
              default: true
            max_cpu:
              type: string
              title: Maximum CPU
              description: Maximum total CPU cores for this node pool.
              default: '1000'
              pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
              x-ui-error-message: Maximum CPU must be a valid Kubernetes resource
                quantity (e.g., 1000, 1000m, 1k)
              x-ui-visible-if:
                field: spec.node_pools.default.enabled
                values:
                - true
            max_memory:
              type: string
              title: Maximum Memory
              description: Maximum total memory for this node pool.
              default: 1000Gi
              pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
              x-ui-error-message: Maximum memory must be a valid Kubernetes resource
                quantity (e.g., 1000Gi, 1Ti, 1000000Mi)
              x-ui-visible-if:
                field: spec.node_pools.default.enabled
                values:
                - true
            use_instance_family:
              type: boolean
              title: Use Instance Family
              description: Toggle to select by instance family (category) or by specific
                instance type.
              default: false
              x-ui-visible-if:
                field: spec.node_pools.default.enabled
                values:
                - true
            instance_family:
              type: string
              title: Instance Family (Category)
              description: Comma-separated EC2 instance families/categories (e.g.,
                c,m,r,g)
              default: c
              pattern: ^[a-z][0-9]*[a-z]*(,[a-z][0-9]*[a-z]*)*$
              x-ui-error-message: Instance families must be comma-separated valid
                EC2 families (e.g., c,m,r,g)
              x-ui-visible-if:
                field: spec.node_pools.default.use_instance_family
                values:
                - true
            instance_types:
              type: string
              title: Instance Types
              description: Comma-separated EC2 instance types for the worker nodes
                (e.g., t3.medium,t3.large)
              default: t3.medium
              pattern: ^[a-z][0-9]+[a-z]*\.(nano|micro|small|medium|large|xlarge|[0-9]+xlarge)(,[a-z][0-9]+[a-z]*\.(nano|micro|small|medium|large|xlarge|[0-9]+xlarge))*$
              x-ui-error-message: Instance types must be comma-separated valid EC2
                instance types (e.g., t3.medium,t3.large)
              x-ui-visible-if:
                field: spec.node_pools.default.use_instance_family
                values:
                - false
            capacity_types:
              type: string
              title: Capacity Types
              description: Comma-separated capacity types (e.g., spot,on-demand)
              default: spot
              pattern: ^(on-demand|spot)(,(on-demand|spot))*$
              x-ui-error-message: Capacity types must be comma-separated values from
                on-demand,spot
              x-ui-visible-if:
                field: spec.node_pools.default.enabled
                values:
                - true
          required:
          - enabled
          - max_cpu
          - max_memory
          - capacity_types
  required:
  - cluster
inputs:
  network_details:
    type: '@facets/aws-vpc-details'
    displayName: Network
    default:
      resource_type: network
      resource_name: default
  cloud_account:
    type: '@outputs/cloud_account'
    displayName: Cloud Account
    description: The AWS Cloud Account where the EKS cluster will be created
    optional: false
    providers:
    - aws
    - aws4
    - aws5
    - aws593
outputs:
  default:
    type: '@outputs/aws_eks'
    title: Kubernetes Cluster Output
    description: The output for the Kubernetes cluster
    providers:
      kubernetes:
        source: hashicorp/kubernetes
        version: 2.17.0
        attributes:
          host: attributes.cluster.auth.host
          token: attributes.cluster.auth.token
          cluster_ca_certificate: attributes.cluster.auth.cluster_ca_certificate
      helm:
        source: hashicorp/helm
        version: 2.8.0
        attributes:
          kubernetes:
            host: attributes.cluster.auth.host
            token: attributes.cluster.auth.token
            cluster_ca_certificate: attributes.cluster.auth.cluster_ca_certificate
      kubernetes-alpha:
        source: hashicorp/kubernetes-alpha
        version: 0.6.0
        attributes:
          host: attributes.cluster.auth.host
          cluster_ca_certificate: attributes.cluster.auth.cluster_ca_certificate
          token: attributes.cluster.auth.token
  default_node_pool:
    type: '@outputs/aws_karpenter_nodepool'
    title: Default Node Pool
    description: The default node pool for AWS Karpenter
  dedicated_node_pool:
    type: '@outputs/aws_karpenter_nodepool'
    title: Dedicated Node Pool
    description: The dedicated node pool for AWS Karpenter
sample:
  kind: kubernetes_cluster
  flavor: aws_eks_demo
  alias-flavors:
  - default
  version: '0.3'
  metadata:
    name: eks-cluster
  spec:
    cluster:
      kubernetes_version: '1.31'
      cluster_endpoint_public_access: true
      cluster_endpoint_private_access: false
      cluster_endpoint_public_access_cidrs:
      - 0.0.0.0/0
      cluster_endpoint_private_access_cidrs:
      - 0.0.0.0/0
    secret_copier:
      enabled: true
      values:
        resources:
          requests:
            cpu: 150m
            memory: 256Mi
    node_pools:
      dedicated:
        enabled: false
        max_cpu: '1000'
        max_memory: 1000Gi
        use_instance_family: false
        instance_types: t3.medium,t3.large
        capacity_types: spot
      default:
        enabled: false
        max_cpu: '1000'
        max_memory: 1000Gi
        use_instance_family: false
        instance_types: t3.medium,t3.large
        capacity_types: spot
    tags: {}
